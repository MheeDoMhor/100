<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ปฏิทินจันทรคติไทย 100 ปี (ฉบับปรับปรุง)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --accent-color: #e74c3c;
            --text-color: #2c3e50;
            --holiday-color: #e74c3c;
            --buddhist-day-color: #f1c40f;
            --today-bg: #e8f4fd;
            --today-border: #3498db;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
            color: var(--text-color);
        }

        .calendar-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .calendar-header h2 {
            margin: 0;
            font-weight: 600;
        }

        .btn-nav {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-nav:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #7f8c8d;
        }

        .weekday {
            padding: 10px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            min-height: 100px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-cell:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            z-index: 10;
        }

        .day-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .day-cell.today {
            background-color: var(--today-bg);
            border: 2px solid var(--today-border);
        }

        .day-cell.selected-highlight {
            background-color: #d4edda !important;
            border: 2px solid #28a745 !important;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .date-number {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .thai-date {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .waxing-waning {
            font-size: 0.75rem;
            color: #34495e;
            display: block;
        }

        .buddhist-icon {
            color: var(--buddhist-day-color);
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1rem;
        }

        /* Holiday Colors */
        .day-col-0 .date-number {
            color: var(--holiday-color);
        }

        /* Sunday */
        .day-col-6 .date-number {
            color: #9b59b6;
        }

        /* Saturday */

        /* Modal Styles */
        .modal-body-custom {
            text-align: center;
        }

        .modal-big-date {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-thai-date {
            font-size: 1.5rem;
            color: #555;
            margin: 10px 0;
        }

        .modal-zodiac {
            font-size: 1.2rem;
            color: #888;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .day-cell {
                min-height: 80px;
            }

            .thai-date,
            .waxing-waning {
                font-size: 0.65rem;
            }
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <button class="btn-nav" id="prevMonth"><i class="fas fa-chevron-left"></i> ก่อนหน้า</button>
            <div id="monthDisplay">
                <h2 id="monthYearText">มกราคม 2567</h2>
                <small id="thaiYearText" class="d-block text-center text-light opacity-75">ปีมะโรง</small>
            </div>
            <button class="btn-nav" id="nextMonth">ถัดไป <i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Toolbar -->
        <div class="row g-2 mb-3 align-items-center justify-content-end">
            <div class="col-auto">
                <select id="searchDay" class="form-select form-select-sm">
                    <option value="" disabled selected>วัน</option>
                    <!-- JS Populate -->
                </select>
            </div>
            <div class="col-auto">
                <select id="searchMonth" class="form-select form-select-sm">
                    <option value="" disabled selected>เดือน</option>
                    <!-- JS Populate -->
                </select>
            </div>
            <div class="col-auto">
                <select id="searchYear" class="form-select form-select-sm">
                    <option value="" disabled selected>พ.ศ.</option>
                    <!-- JS Populate -->
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary btn-sm" id="btnSearchGo"><i class="fas fa-search"></i> ค้นหา</button>
            </div>
            <div class="col-auto border-start ps-3 ms-2">
                <button class="btn btn-outline-primary btn-sm" id="goToday">วันนี้</button>
            </div>
        </div>

        <!-- Hidden because we replaced functionality but keeping for structure if needed -->
        <!-- <div class="d-flex justify-content-end mb-3"> -->
        <select id="yearSelect" class="form-select form-select-sm w-auto d-none">
            <!-- JS will populate -->
        </select>
        <!-- </div> -->

        <div class="weekdays">
            <div style="color: #e74c3c;">อาทิตย์</div>
            <div style="color: #f1c40f;">จันทร์</div>
            <div style="color: #e91e63;">อังคาร</div>
            <div style="color: #2ecc71;">พุธ</div>
            <div style="color: #e67e22;">พฤหัสบดี</div>
            <div style="color: #3498db;">ศุกร์</div>
            <div style="color: #9b59b6;">เสาร์</div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- JS will populate days here -->
        </div>
    </div>

    <!-- Modal for details -->
    <div class="modal fade" id="dateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">รายละเอียดวัน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-body-custom">
                    <div class="modal-big-date" id="modalDay">1</div>
                    <div id="modalMonthYear">มกราคม 2567</div>
                    <hr>
                    <div class="modal-thai-date" id="modalThaiDate">แรม 15 ค่ำ เดือน 2</div>
                    <div class="modal-zodiac" id="modalZodiac">ปีเถาะ (กระต่าย)</div>
                    <div id="modalPhase" class="mt-2 badge bg-info text-dark">ข้างแรม</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Data from PHP Generator ---
        // type: 0 = Normal, 1 = Pickawan (Extra Day), 2 = Athikamat (Extra Month 88)
        const YEAR_DATA = [
            { be: 2400, ad: 1857, type: 0 }, { be: 2401, ad: 1858, type: 2 }, { be: 2402, ad: 1859, type: 0 }, { be: 2403, ad: 1860, type: 1 },
            { be: 2404, ad: 1861, type: 2 }, { be: 2405, ad: 1862, type: 0 }, { be: 2406, ad: 1863, type: 2 }, { be: 2407, ad: 1864, type: 0 },
            { be: 2408, ad: 1865, type: 1 }, { be: 2409, ad: 1866, type: 2 }, { be: 2410, ad: 1867, type: 0 }, { be: 2411, ad: 1868, type: 0 },
            { be: 2412, ad: 1869, type: 2 }, { be: 2413, ad: 1870, type: 0 }, { be: 2414, ad: 1871, type: 1 }, { be: 2415, ad: 1872, type: 2 },
            { be: 2416, ad: 1873, type: 0 }, { be: 2417, ad: 1874, type: 2 }, { be: 2418, ad: 1875, type: 0 }, { be: 2419, ad: 1876, type: 1 },
            { be: 2420, ad: 1877, type: 2 }, { be: 2421, ad: 1878, type: 0 }, { be: 2422, ad: 1879, type: 0 }, { be: 2423, ad: 1880, type: 2 },
            { be: 2424, ad: 1881, type: 1 }, { be: 2425, ad: 1882, type: 2 }, { be: 2426, ad: 1883, type: 0 }, { be: 2427, ad: 1884, type: 0 },
            { be: 2428, ad: 1885, type: 2 }, { be: 2429, ad: 1886, type: 0 }, { be: 2430, ad: 1887, type: 1 }, { be: 2431, ad: 1888, type: 2 },
            { be: 2432, ad: 1889, type: 0 }, { be: 2433, ad: 1890, type: 2 }, { be: 2434, ad: 1891, type: 0 }, { be: 2435, ad: 1892, type: 1 },
            { be: 2436, ad: 1893, type: 2 }, { be: 2437, ad: 1894, type: 0 }, { be: 2438, ad: 1895, type: 0 }, { be: 2439, ad: 1896, type: 2 },
            { be: 2440, ad: 1897, type: 0 }, { be: 2441, ad: 1898, type: 1 }, { be: 2442, ad: 1899, type: 2 }, { be: 2443, ad: 1900, type: 0 },
            { be: 2444, ad: 1901, type: 2 }, { be: 2445, ad: 1902, type: 0 }, { be: 2446, ad: 1903, type: 1 }, { be: 2447, ad: 1904, type: 2 },
            { be: 2448, ad: 1905, type: 0 }, { be: 2449, ad: 1906, type: 0 }, { be: 2450, ad: 1907, type: 2 }, { be: 2451, ad: 1908, type: 1 },
            { be: 2452, ad: 1909, type: 2 }, { be: 2453, ad: 1910, type: 0 }, { be: 2454, ad: 1911, type: 0 }, { be: 2455, ad: 1912, type: 2 },
            { be: 2456, ad: 1913, type: 0 }, { be: 2457, ad: 1914, type: 1 }, { be: 2458, ad: 1915, type: 2 }, { be: 2459, ad: 1916, type: 0 },
            { be: 2460, ad: 1917, type: 1 }, { be: 2461, ad: 1918, type: 2 }, { be: 2462, ad: 1919, type: 0 }, { be: 2463, ad: 1920, type: 2 },
            { be: 2464, ad: 1921, type: 0 }, { be: 2465, ad: 1922, type: 0 }, { be: 2466, ad: 1923, type: 2 }, { be: 2467, ad: 1924, type: 0 },
            { be: 2468, ad: 1925, type: 1 }, { be: 2469, ad: 1926, type: 2 }, { be: 2470, ad: 1927, type: 0 }, { be: 2471, ad: 1928, type: 2 },
            { be: 2472, ad: 1929, type: 1 }, { be: 2473, ad: 1930, type: 0 }, { be: 2474, ad: 1931, type: 2 }, { be: 2475, ad: 1932, type: 0 },
            { be: 2476, ad: 1933, type: 1 }, { be: 2477, ad: 1934, type: 2 }, { be: 2478, ad: 1935, type: 0 }, { be: 2479, ad: 1936, type: 1 },
            { be: 2480, ad: 1937, type: 2 }, { be: 2481, ad: 1938, type: 0 }, { be: 2482, ad: 1939, type: 2 }, { be: 2483, ad: 1940, type: 0 },
            { be: 2484, ad: 1941, type: 0 }, { be: 2485, ad: 1942, type: 2 }, { be: 2486, ad: 1943, type: 0 }, { be: 2487, ad: 1944, type: 2 },
            { be: 2488, ad: 1945, type: 1 }, { be: 2489, ad: 1946, type: 0 }, { be: 2490, ad: 1947, type: 2 }, { be: 2491, ad: 1948, type: 0 },
            { be: 2492, ad: 1949, type: 1 }, { be: 2493, ad: 1950, type: 2 }, { be: 2494, ad: 1951, type: 0 }, { be: 2495, ad: 1952, type: 1 },
            { be: 2496, ad: 1953, type: 2 }, { be: 2497, ad: 1954, type: 0 }, { be: 2498, ad: 1955, type: 0 }, { be: 2499, ad: 1956, type: 2 },
            { be: 2500, ad: 1957, type: 1 }, { be: 2501, ad: 1958, type: 2 }, { be: 2502, ad: 1959, type: 0 }, { be: 2503, ad: 1960, type: 0 },
            { be: 2504, ad: 1961, type: 2 }, { be: 2505, ad: 1962, type: 0 }, { be: 2506, ad: 1963, type: 1 }, { be: 2507, ad: 1964, type: 2 },
            { be: 2508, ad: 1965, type: 0 }, { be: 2509, ad: 1966, type: 2 }, { be: 2510, ad: 1967, type: 0 }, { be: 2511, ad: 1968, type: 0 },
            { be: 2512, ad: 1969, type: 2 }, { be: 2513, ad: 1970, type: 1 }, { be: 2514, ad: 1971, type: 0 }, { be: 2515, ad: 1972, type: 2 },
            { be: 2516, ad: 1973, type: 1 }, { be: 2517, ad: 1974, type: 0 }, { be: 2518, ad: 1975, type: 2 }, { be: 2519, ad: 1976, type: 0 },
            { be: 2520, ad: 1977, type: 2 }, { be: 2521, ad: 1978, type: 0 }, { be: 2522, ad: 1979, type: 1 }, { be: 2523, ad: 1980, type: 2 },
            { be: 2524, ad: 1981, type: 0 }, { be: 2525, ad: 1982, type: 0 }, { be: 2526, ad: 1983, type: 2 }, { be: 2527, ad: 1984, type: 0 },
            { be: 2528, ad: 1985, type: 2 }, { be: 2529, ad: 1986, type: 0 }, { be: 2530, ad: 1987, type: 1 }, { be: 2531, ad: 1988, type: 2 },
            { be: 2532, ad: 1989, type: 0 }, { be: 2533, ad: 1990, type: 1 }, { be: 2534, ad: 1991, type: 2 }, { be: 2535, ad: 1992, type: 0 },
            { be: 2536, ad: 1993, type: 2 }, { be: 2537, ad: 1994, type: 0 }, { be: 2538, ad: 1995, type: 0 }, { be: 2539, ad: 1996, type: 2 },
            { be: 2540, ad: 1997, type: 1 }, { be: 2541, ad: 1998, type: 0 }, { be: 2542, ad: 1999, type: 2 }, { be: 2543, ad: 2000, type: 1 },
            { be: 2544, ad: 2001, type: 0 }, { be: 2545, ad: 2002, type: 2 }, { be: 2546, ad: 2003, type: 0 }, { be: 2547, ad: 2004, type: 2 },
            { be: 2548, ad: 2005, type: 0 }, { be: 2549, ad: 2006, type: 1 }, { be: 2550, ad: 2007, type: 2 }, { be: 2551, ad: 2008, type: 0 },
            { be: 2552, ad: 2009, type: 1 }, { be: 2553, ad: 2010, type: 2 }, { be: 2554, ad: 2011, type: 0 }, { be: 2555, ad: 2012, type: 2 },
            { be: 2556, ad: 2013, type: 0 }, { be: 2557, ad: 2014, type: 1 }, { be: 2558, ad: 2015, type: 2 }, { be: 2559, ad: 2016, type: 0 },
            { be: 2560, ad: 2017, type: 0 }, { be: 2561, ad: 2018, type: 2 }, { be: 2562, ad: 2019, type: 0 }, { be: 2563, ad: 2020, type: 0 },
            { be: 2564, ad: 2021, type: 2 }, { be: 2565, ad: 2022, type: 0 }, { be: 2566, ad: 2023, type: 2 }, { be: 2567, ad: 2024, type: 0 },
            { be: 2568, ad: 2025, type: 1 }, { be: 2569, ad: 2026, type: 2 }, { be: 2570, ad: 2027, type: 0 }, { be: 2571, ad: 2028, type: 0 },
            { be: 2572, ad: 2029, type: 2 }, { be: 2573, ad: 2030, type: 1 }, { be: 2574, ad: 2031, type: 2 }, { be: 2575, ad: 2032, type: 0 },
        ];

        const THAI_MONTHS = [
            "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
            "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
        ];

        const ZODIACS = [
            "ชวด", "ฉลู", "ขาล", "เถาะ", "มะโรง", "มะเส็ง",
            "มะเมีย", "มะแม", "วอก", "ระกา", "จอ", "กุน"
        ];

        // --- State ---
        let currentDate = new Date();
        let highlightDate = null; // Store searched date to highlight

        // --- Logic ---

        // This function calculates Thai date by simulating the year cycle from base date
        function getThaiDateMap(targetYear, targetMonth) {
            // Find cached or calculation starting point
            // For simplicity and correctness based on old code, we must start from base
            // Base: 1856-11-28 provided in PHP code as start of calculation
            // But the loop starts from YEAR_DATA[0] (AD 1857)

            let loopDate = new Date(1856, 10, 28, 12, 0, 0); // Noon to avoid timezone shifts
            let nextAsterismYear = 6; // Starts at Maseng (Snake)

            // Target Date to stop (End of target month)
            // We need data for the whole target Month.
            // So we run until we pass the target month.

            // Optimization: We could jump, but looping 60k days is < 50ms in modern JS. 
            // Let's implement the exact logic from PHP.

            let resultMap = {}; // Key: "YYYY-MM-DD", Value: Object

            for (let i = 0; i < YEAR_DATA.length; i++) {
                let yearInfo = YEAR_DATA[i];
                let type = yearInfo.type;

                // If current loop year > targetYear, we can stop (after finishing this year?)
                // Actually we render by month, so we need to reach targetYear

                if (yearInfo.ad > targetYear + 1) break; // Stop early

                let monthEightCount = 1;

                for (let month = 1; month <= 12; month++) {
                    let ay = nextAsterismYear;
                    if (month < 5) ay = nextAsterismYear - 1;
                    if (ay < 1) ay += 12; // Adjust if wrapped (though logic says ay = next -1)

                    // PHP Logic: if(month < 5) $ay = $nextAsterismYear - 1;
                    // Note: The variable nextAsterismYear increments at end of year.

                    // Waxing (Khuen) 1-15
                    for (let up = 1; up <= 15; up++) {
                        // Check if loopDate is in our target view range
                        // To optimize, only store if near targetYear
                        if (yearInfo.ad === targetYear && month === targetMonth + 1) {
                            // Wait, PHP loop month is Thai month logic? No, PHP loop is just 1-12
                            // Let's look at PHP: for($month = 1; $month <= 12; $month++)
                            // It iterates 12 times (blocks), but thai_month variable depends on logic
                        }

                        // Actually, the PHP loop generates THE WHOLE YEAR of dates sequentially.
                        // The 'month' variable in PHP loop is NOT Gregorian month. It is close to Thai month.
                        // But date_add adds 1 day to Gregorian date.

                        let y = loopDate.getFullYear();
                        let m = loopDate.getMonth() + 1; // 0-11 to 1-12
                        let d = loopDate.getDate();
                        let dateKey = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                        let thaiMonth = month;
                        if (month === 8 && monthEightCount === 2) thaiMonth = "88"; // 8 Song Hon

                        if (y === targetYear && (loopDate.getMonth() === targetMonth)) {
                            resultMap[dateKey] = {
                                thaiDate: `ขึ้น ${up} ค่ำ เดือน ${thaiMonth == "88" ? "8-8" : thaiMonth}`,
                                zodiac: ZODIACS[ay - 1],
                                phase: 'ขึ้น',
                                phaseDay: up
                            };
                        }

                        loopDate.setDate(loopDate.getDate() + 1);
                    }

                    // Waning (Raem)
                    let downLimit = ((month % 2 !== 1) || (type === 1 && month === 7) ? 15 : 14);

                    for (let down = 1; down <= downLimit; down++) {
                        let y = loopDate.getFullYear();
                        let m = loopDate.getMonth() + 1;
                        let d = loopDate.getDate();
                        let dateKey = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                        let thaiMonth = month;
                        if (month === 8 && monthEightCount === 2) thaiMonth = "88";

                        if (y === targetYear && (loopDate.getMonth() === targetMonth)) {
                            resultMap[dateKey] = {
                                thaiDate: `แรม ${down} ค่ำ เดือน ${thaiMonth == "88" ? "8-8" : thaiMonth}`,
                                zodiac: ZODIACS[ay - 1],
                                phase: 'แรม',
                                phaseDay: down
                            };
                        }

                        loopDate.setDate(loopDate.getDate() + 1);
                    }

                    // Logic for Athikamat (Month 8 twice)
                    if (type === 2 && month === 8 && monthEightCount < 2) {
                        month--; // Repeat month 8
                        monthEightCount++;
                    }
                }

                nextAsterismYear++;
                if (nextAsterismYear > 12) nextAsterismYear = 1;
            }

            return resultMap;
        }

        // --- UI Rendering ---

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update Header
            $('#monthYearText').text(`${THAI_MONTHS[month]} ${year + 543}`);
            $('#yearSelect').val(year);

            // Calculate Thai Dates
            // Optimization: Ideally we shouldn't run this every render if year hasn't changed drastically
            // But for now it's fine.
            let thaiData = getThaiDateMap(year, month);

            // Find Zodiac of the month (Take the 15th as represent)
            let midMonthKey = `${year}-${String(month + 1).padStart(2, '0')}-15`;
            if (thaiData[midMonthKey]) {
                $('#thaiYearText').text(`ปี${thaiData[midMonthKey].zodiac}`);
            }

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayIndex = firstDay.getDay(); // 0 = Sunday

            const grid = $('#calendarGrid');
            grid.empty();

            // Empty cells before 1st day
            for (let i = 0; i < startDayIndex; i++) {
                grid.append('<div class="day-cell empty"></div>');
            }

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                let dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                let tData = thaiData[dateKey] || { thaiDate: '-', zodiac: '-', phase: '', phaseDay: 0 };

                let isToday = isCurrentMonth && today.getDate() === d;

                // Highlight Searched Date
                let isHighlight = false;
                if (highlightDate &&
                    highlightDate.getFullYear() === year &&
                    highlightDate.getMonth() === month &&
                    highlightDate.getDate() === d) {
                    isHighlight = true;
                }

                // Wan Phra Check (8, 15 Waxing or 8, 15/14 Waning)
                let isWanPhra = false;
                if (tData.phaseDay === 8 || tData.phaseDay === 15) isWanPhra = true;
                // Special case: Raem 14 Kham in months with 14 days
                if (tData.phase == 'แรม' && tData.phaseDay === 14) {
                    // Basic check: if tomorrow is Waxing 1, then today is Wan Phra
                    // But we don't have tomorrow data easily here without lookahead.
                    // However, standard Wan Phra is usually 8, 15.
                    // In Thai calendar, End of month is Wan Phra.
                    // If Month is odd (Ex 29 days), Raem 14 is end.
                }
                // Simplify for now: 8 and 15

                let cellHtml = `
                <div class="day-cell day-col-${(startDayIndex + d - 1) % 7} ${isToday ? 'today' : ''} ${isHighlight ? 'selected-highlight' : ''}" 
                     data-date="${d}" data-thai="${tData.thaiDate}" data-zodiac="${tData.zodiac}" data-phase="${tData.phase}">
                    <div class="date-number">${d}</div>
                    <div class="thai-date">${tData.thaiDate}</div>
                    ${isWanPhra ? '<i class="fas fa-dharmachakra buddhist-icon" title="วันพระ"></i>' : ''}
                </div>
            `;
                grid.append(cellHtml);
            }
        }

        // --- Events ---
        $(document).ready(function () {
            // Populate Year Select
            // Populate Year Select (Both View and Search)
            // Populate Days (1-31)
            for (let i = 1; i <= 31; i++) {
                $('#searchDay').append(`<option value="${i}">${i}</option>`);
            }
            // Populate Months
            THAI_MONTHS.forEach((m, index) => {
                $('#searchMonth').append(`<option value="${index}">${m}</option>`);
            });

            YEAR_DATA.forEach(y => {
                $('#yearSelect').append(`<option value="${y.ad}">${y.ad + 543}</option>`);
                $('#searchYear').append(`<option value="${y.ad}">${y.ad + 543}</option>`);
            });

            renderCalendar();

            $('#prevMonth').click(() => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            $('#nextMonth').click(() => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            $('#goToday').click(() => {
                currentDate = new Date();
                highlightDate = null; // Clear highlight
                renderCalendar();
            });

            $('#btnSearchGo').click(() => {
                let d = parseInt($('#searchDay').val());
                let m = parseInt($('#searchMonth').val());
                let y = parseInt($('#searchYear').val());

                if (!d || isNaN(m) || !y) {
                    alert('กรุณาเลือก วัน เดือน ปี ให้ครบถ้วน');
                    return;
                }

                // Set date
                // Note: Month in Date constructor is 0-indexed
                let newDate = new Date(y, m, d);

                // Validate if day exists (e.g. 31 Feb)
                if (newDate.getMonth() !== m) {
                    alert('วันที่ไม่ถูกต้อง (เดือนนี้ไม่มีวันดังกล่าว)');
                    return;
                }

                currentDate = newDate;
                highlightDate = newDate; // Set highlight
                renderCalendar();
            });

            $('#yearSelect').change(function () {
                currentDate.setFullYear($(this).val());
                renderCalendar();
            });

            // Cell Click
            $(document).on('click', '.day-cell:not(.empty)', function () {
                let day = $(this).data('date');
                let thai = $(this).data('thai');
                let zodiac = $(this).data('zodiac');
                let phase = $(this).data('phase');

                $('#modalDay').text(day);
                $('#modalMonthYear').text($('#monthYearText').text());
                $('#modalThaiDate').text(thai);
                $('#modalZodiac').text(`ปี${zodiac}`);
                $('#modalPhase').text(phase === 'ขึ้น' ? 'ข้างขึ้น (Waxing)' : 'ข้างแรม (Waning)');

                new bootstrap.Modal(document.getElementById('dateModal')).show();
            });
        });

    </script>
</body>

</html>